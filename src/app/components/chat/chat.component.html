<div class="chat-page-container">
  <mat-card class="chat-card">
    <div class="chat-header">
      <div class="chat-title">Chat privado</div>
      <div class="chat-subtitle" *ngIf="authService.currentRole === 'cliente'">
        <ng-container *ngIf="destinatarioSeleccionado; else sinSoporte">
          Te atiende: {{ destinatarioSeleccionado.email }} <span *ngIf="destinatarioSeleccionado.rol">({{ destinatarioSeleccionado.rol }})</span>
        </ng-container>
        <ng-template #sinSoporte>
          No hay operador disponible
        </ng-template>
      </div>
    </div>

    <div class="chat-destino" *ngIf="authService.currentRole === 'operador' || authService.currentRole === 'admin'">
      <mat-form-field appearance="outline" class="chat-user-filter">
        <mat-label>Buscar usuario</mat-label>
        <input
          matInput
          type="text"
          placeholder="Buscar usuario..."
          [(ngModel)]="filtroUsuario"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="chat-destino-field">
      <mat-label>Conversar con</mat-label>
      <mat-select
        [(value)]="destinatarioSeleccionado"
        (selectionChange)="onSeleccionDestinatario($event.value)"
      >
        <mat-option *ngFor="let u of getUsuariosFiltrados()" [value]="u">
          {{ u.email }} <span *ngIf="u.rol">({{ u.rol }})</span>
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

    <div class="chat-filtro">
      <mat-form-field appearance="outline" class="chat-filtro-field">
        <mat-label>Filtrar mensajes</mat-label>
        <input
          matInput
          type="text"
          placeholder="Buscar por texto o email..."
          [(ngModel)]="filtroTexto"
        />
      </mat-form-field>
    </div>

    <div *ngIf="isLoading" class="chat-loading">
      Cargando mensajes...
    </div>

    <div
      #messagesContainer
      class="mensajes-lista"
      *ngIf="!isLoading"
    >
      <div
        class="mensaje-wrapper"
        *ngFor="let msg of mensajes | chatFilter:filtroTexto"
        [appMyMessage]="msg.uidRemitente"
      >
        <div class="msg-header">
          <span class="msg-email">{{ msg.emailRemitente }}</span>
          <span class="msg-fecha">
            {{ msg.timestamp | date:'short' }}
          </span>
        </div>
        <div class="msg-texto">
          {{ msg.texto }}
        </div>
      </div>

      <div *ngIf="!mensajes?.length && !isLoading" class="chat-empty">
        No hay mensajes todavia. Escribi el primero :)
      </div>
    </div>

    <div class="chat-input">
      <mat-form-field class="chat-input-field" appearance="outline">
        <mat-label>Escribi tu mensaje</mat-label>
        <input
          matInput
          [(ngModel)]="mensajeNuevo"
          (keyup.enter)="enviarMensaje()"
          [disabled]="!destinatarioSeleccionado || !uidActual"
        />
      </mat-form-field>

      <button
        mat-raised-button
        color="primary"
        (click)="enviarMensaje()"
        [disabled]="!mensajeNuevo?.trim() || !destinatarioSeleccionado || !uidActual"
      >
        Enviar
      </button>
    </div>
  </mat-card>
</div>
