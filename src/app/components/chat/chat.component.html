<div class="chat-page-container">
  <mat-card class="chat-card">
    <div *ngIf="quotaExcedida" style="color:#b00020; font-size:13px; margin-bottom:6px;">
      No se puede cargar el chat en este momento (limite de Firestore).
    </div>
    <div class="chat-header">
      <div class="chat-title">Chat privado</div>
      <div class="chat-subtitle" *ngIf="authService.currentRole === 'cliente'">
        <ng-container *ngIf="destinatarioSeleccionado; else sinSoporte">
          Te atiende:
          {{ destinatarioSeleccionado.email }}
          <span *ngIf="destinatarioSeleccionado.rol">
            ({{ destinatarioSeleccionado.rol }})
          </span>
        </ng-container>
        <ng-template #sinSoporte>No hay operador disponible</ng-template>
      </div>
    </div>

    <!-- Lista de conversaciones para operador/admin -->
    <div
      class="chat-conversaciones"
      *ngIf="authService.currentRole === 'operador' || authService.currentRole === 'admin'"
    >
      <h4>Conversaciones</h4>
      <div class="conv-lista">
      <div
        class="conv-item"
        *ngFor="let conv of conversaciones; trackBy: trackByChatId"
        (click)="seleccionarConversacion(conv)"
          [class.unread]="(conv?.unread || 0) > 0"
        >
          <div class="conv-main">
            <span class="conv-email">
              {{ getNombreDesdeEmail(conv.emailOtro) }}
            </span>
            <span class="badge-unread" *ngIf="(conv?.unread || 0) > 0">{{ conv.unread }}</span>
            <span class="conv-ultimo">
              - {{ conv.ultimoMensaje }}
            </span>
          </div>
          <div class="conv-fecha">
            {{ conv.timestamp | date: 'd/M' }}
          </div>
        </div>

        <div *ngIf="!conversaciones.length" class="conv-vacia">
          No hay conversaciones
        </div>
      </div>
    </div>

    <!-- Selector de destinatario para operador/admin -->
    <div
      class="chat-destino"
      *ngIf="authService.currentRole === 'operador' || authService.currentRole === 'admin'"
    >
      <!-- Buscar usuario: solo placeholder -->
      <mat-form-field
        appearance="outline"
        class="chat-user-filter compact-field"
      >
        <input
          matInput
          type="text"
          placeholder="Buscar usuario..."
          [(ngModel)]="filtroUsuario"
        />
      </mat-form-field>

      <!-- Conversar con -->
      <mat-form-field appearance="outline" class="chat-destino-field compact-field">
        <mat-select
          placeholder="Conversar con"
          [(value)]="destinatarioSeleccionado"
          (selectionChange)="onSeleccionDestinatario($event.value)">
          
          <mat-option *ngFor="let u of getUsuariosFiltrados()" [value]="u">
            {{ u.email }}
            <span *ngIf="u.rol">({{ u.rol }})</span>
          </mat-option>
        </mat-select>
      </mat-form-field>

    </div>

    <!-- Lista de mensajes -->
    <div *ngIf="isLoading" class="chat-loading">Cargando mensajes...</div>

    <div #messagesContainer class="mensajes-lista chat-messages" *ngIf="!isLoading">
      <div
        class="mensaje-wrapper"
        *ngFor="let msg of mensajes | chatFilter: filtroTexto; trackBy: trackByMsgId"
        [appMyMessage]="msg.uidRemitente"
      >
        <div class="msg-header">
          <span class="msg-email">{{ msg.emailRemitente }}</span>
          <span class="msg-fecha">{{ msg.timestamp | date: 'short' }}</span>
        </div>
        <div class="msg-texto">
          {{ msg.texto }}
        </div>
      </div>

      <div *ngIf="!mensajes?.length && !isLoading" class="chat-empty">
        No hay mensajes todavia. Escribi el primero :)
      </div>
    </div>

    <!-- Input y boton de envio -->
    <div class="chat-input">
      <!-- Campo de mensaje: solo placeholder -->
      <mat-form-field
        class="chat-input-field compact-field"
        appearance="outline"
      >
        <input
          matInput
          placeholder="Escribi tu mensaje"
          [(ngModel)]="mensajeNuevo"
          (keyup.enter)="enviarMensaje()"
          [disabled]="!destinatarioSeleccionado || !uidActual"
        />
      </mat-form-field>

      <button
        mat-raised-button
        color="primary"
        (click)="enviarMensaje()"
        [disabled]="
          !mensajeNuevo ||
          !mensajeNuevo.trim() ||
          !destinatarioSeleccionado ||
          !uidActual
        "
      >
        Enviar
      </button>
    </div>
  </mat-card>
</div>
